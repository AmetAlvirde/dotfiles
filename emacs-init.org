#+TITLE: Emacs configuration
#+AUTHOR: Amet Alvirde

#+BEGIN_SRC emacs-lisp
(require 'package)

(add-to-list 'package-archives '("org" . "http://orgmode.org/elpa/"))
(add-to-list 'package-archives '("melpa" . "http://melpa.org/packages/"))
(add-to-list 'package-archives '("melpa-stable" . "http://stable.melpa.org/packages/"))

(setq package-enable-at-startup nil)
(package-initialize)

(require 'evil)
(evil-mode t)

;; Insane backup files madness getting managed:

;; Default and per-save backups go here:
(setq backup-directory-alist '(("" . "~/.emacs.d/backup/per-save")))

(defun force-backup-of-buffer ()
  ;; Make a special "per session" backup at the first save of each
  ;; emacs session.
  (when (not buffer-backed-up)
    ;; Override the default parameters for per-session backups.
    (let ((backup-directory-alist '(("" . "~/.emacs.d/backup/per-session")))
          (kept-new-versions 3))
      (backup-buffer)))
  ;; Make a "per save" backup on each save.  The first save results in
  ;; both a per-session and a per-save backup, to keep the numbering
  ;; of per-save backups consistent.
  (let ((buffer-backed-up nil))
    (backup-buffer)))

(add-hook 'before-save-hook  'force-backup-of-buffer)

;; magit set-up
(require 'magit)
(with-eval-after-load 'info
  (info-initialize)
  (add-to-list 'Info-directory-list
               "~/.emacs.d/site-lisp/magit/Documentation/"))

;; magit set-up
(global-set-key (kbd "C-x g") 'magit-status)

; make magit status go full-screen but remember previous window
;; settings
;; from: http://whattheemacsd.com/setup-magit.el-01.html
(defadvice magit-status (around magit-fullscreen activate)
    (window-configuration-to-register :magit-fullscreen)
    ad-do-it
    (delete-other-windows))

(setq column-number-mode t)

;; Cool utf8 bullets to our org mode that I can't get wieking in
;; terminal mode. But I will. Someday. Definitely.
;;(require 'org-bullets)
;;  (add-hook 'org-mode-hook (lambda () (org-bullets-mode 2)))

;; Hide leading stars
(setq org-startup-indented t
      org-hide-leading-stars t)

(menu-bar-mode -1)

;;Column indicator limit stuff:
(require 'fill-column-indicator)
(add-hook 'after-change-major-mode-hook 'fci-mode)
(setq-default fill-column 90)

;; Since this file lives in a dotfiles repository, emacs continuosly asks
;; if it should follow the symlink to the actual file. This prevents the
;; tedious asking part and tells emacs to alwats follow the symlink
(setq vc-follow-symlinks t)

(defun ensure-package-installed (&rest packages)
  "Assure every package is installed, ask for installation if itâ€™s not.

Return a list of installed packages or nil for every skipped package."
  (mapcar
   (lambda (package)
     (if (package-installed-p package)
         nil
       (if (y-or-n-p (format "Package %s is missing. Install it? " package))
           (package-install package)
         package)))
   packages))

;; Make sure to have downloaded archive description.
(or (file-exists-p package-user-dir)
    (package-refresh-contents))

;; Activate installed packages
(package-initialize)

;; Assuming you wish to install "iedit" and "magit"
(ensure-package-installed 'evil)

;; Set encoding system to utlf-8
(prefer-coding-system 'utf-8)
(setq-default buffer-file-coding-system 'utf-8-auto-unix)

;; Change yes or no questions to y or n
(fset 'yes-or-no-p 'y-or-n-p)

;; Workaround for org-mode problem with gnome terminal
;; https://gist.github.com/hanachin/997420
(add-hook 'org-mode-hook
  (lambda ()
    (if window-system
        nil
      (progn
        (define-key evil-normal-state-map (kbd "TAB") 'org-cycle)
        (define-key org-mode-map (kbd "C-M-j") 'org-meta-return)
        ;; -nw has no ALT+arrows. Remmaped to C-c <Vim-direction-ky>
        (define-key org-mode-map (kbd "C-c l") 'org-metaright)
        (define-key org-mode-map (kbd "C-c h") 'org-metaleft)
        (define-key org-mode-map (kbd "C-c j") 'org-metadown)
        (define-key org-mode-map (kbd "C-c k") 'org-metaup)
      )
    )
  )
)
#+END_SRC
